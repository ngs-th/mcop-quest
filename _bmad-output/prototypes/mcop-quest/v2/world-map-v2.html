<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no"
        />
        <title>MCOP Quest - World Map</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=VT323&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg-parchment: #e8dcc0;
                --bg-parchment-dark: #d4c8a8;
                --border-gold: #c9a227;
                --text-dark: #2c2416;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Crimson Text', Georgia, serif;
                background: linear-gradient(135deg, #1a0f0a 0%, #2c1810 50%, #1a0f0a 100%);
                color: #f4e8d0;
                min-height: 100vh;
                overflow-x: hidden;
                padding-bottom: 80px;
            }

            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image:
                    radial-gradient(circle at 20% 30%, rgba(212, 168, 83, 0.08) 0%, transparent 50%),
                    radial-gradient(circle at 80% 70%, rgba(192, 57, 43, 0.05) 0%, transparent 40%),
                    url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4a853' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                pointer-events: none;
                z-index: -1;
            }

            .font-fantasy {
                font-family: "Cinzel", serif;
            }

            .golden-frame {
                border: 8px solid var(--border-gold);
                border-image: linear-gradient(
                        135deg,
                        #bf953f 0%,
                        #fcf6ba 25%,
                        #b38728 50%,
                        #fbf5b7 75%,
                        #aa771c 100%
                    )
                    1;
                box-shadow:
                    inset 0 0 30px rgba(0, 0, 0, 0.5),
                    0 0 20px rgba(201, 162, 39, 0.3);
            }

            /* Header */
            .header {
                background: linear-gradient(180deg, #2c1810 0%, #1a0f0a 100%);
                border-bottom: 3px solid #8b6914;
                padding: 15px 20px;
                position: sticky;
                top: 0;
                z-index: 100;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            }

            .resource-counter {
                background: linear-gradient(145deg, #3d2418 0%, #2c1810 100%);
                border: 2px solid #8b6914;
                padding: 8px 16px;
                display: flex;
                align-items: center;
                gap: 8px;
                border-radius: 8px;
            }

            /* Map Container */
            #map-container {
                position: relative;
                background: linear-gradient(135deg, #2d5016 0%, #3d6b26 50%, #2d5016 100%);
                overflow: hidden;
            }

            canvas {
                display: block;
                cursor: grab;
            }

            canvas:active {
                cursor: grabbing;
            }

            /* Loading Overlay */
            .loading-overlay {
                position: absolute;
                inset: 0;
                background: #1a1510;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 50;
                transition: opacity 0.5s;
            }

            .loading-overlay.hidden {
                opacity: 0;
                pointer-events: none;
            }

            .loading-spinner {
                width: 60px;
                height: 60px;
                border: 4px solid #d4a853;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Zoom Controls */
            .zoom-controls {
                position: absolute;
                bottom: 20px;
                right: 20px;
                display: flex;
                flex-direction: column;
                gap: 8px;
                z-index: 20;
            }

            .zoom-btn {
                width: 44px;
                height: 44px;
                background: linear-gradient(145deg, #3d2418 0%, #2c1810 100%);
                border: 2px solid #8b6914;
                border-radius: 8px;
                font-size: 24px;
                font-weight: bold;
                color: #d4a853;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: 'Cinzel', serif;
            }

            .zoom-btn:hover {
                background: linear-gradient(145deg, #4d3428 0%, #3c2820 100%);
                border-color: #d4a853;
                transform: scale(1.05);
            }

            /* Mini Map */
            .minimap-container {
                position: absolute;
                top: 16px;
                left: 16px;
                background: linear-gradient(145deg, #3d2418 0%, #2c1810 100%);
                border: 2px solid #8b6914;
                border-radius: 12px;
                padding: 10px;
                width: 180px;
                height: 140px;
                z-index: 20;
            }

            .minimap-title {
                font-family: 'Cinzel', serif;
                font-size: 11px;
                color: #d4a853;
                text-align: center;
                margin-bottom: 6px;
            }

            .minimap-canvas {
                width: 100%;
                height: 100px;
                background: #1a3320;
                border-radius: 6px;
                border: 1px solid #5c4018;
            }

            /* Location Modal */
            .location-modal {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.8);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 100;
                padding: 20px;
            }

            .location-modal.active {
                display: flex;
            }

            .modal-content {
                background: linear-gradient(145deg, #3d2418 0%, #2c1810 100%);
                border: 3px solid #8b6914;
                border-radius: 16px;
                padding: 24px;
                max-width: 400px;
                width: 100%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            }

            .modal-title {
                font-family: 'Cinzel', serif;
                font-size: 24px;
                color: #d4a853;
                margin-bottom: 16px;
                text-align: center;
            }

            .modal-info {
                color: #f4e8d0;
                font-size: 16px;
                line-height: 1.8;
            }

            .modal-info strong {
                color: #d4a853;
            }

            .health-indicator {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 4px;
                font-weight: bold;
                font-size: 14px;
            }

            .health-full { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
            .health-stable { background: rgba(52, 152, 219, 0.2); color: #3498db; }
            .health-medium { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
            .health-low { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
            .health-foggy { background: rgba(149, 165, 166, 0.2); color: #95a5a6; }

            .modal-close-btn {
                margin-top: 20px;
                width: 100%;
                background: linear-gradient(145deg, #8b6914 0%, #6b5010 100%);
                border: 2px solid #d4a853;
                color: #f4e8d0;
                padding: 12px;
                border-radius: 8px;
                font-family: 'Cinzel', serif;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .modal-close-btn:hover {
                background: linear-gradient(145deg, #9b7924 0%, #7b6020 100%);
            }

            .modal-actions {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }

            .modal-action-btn {
                flex: 1;
                padding: 12px;
                border-radius: 8px;
                font-family: 'Cinzel', serif;
                font-size: 14px;
                text-align: center;
                text-decoration: none;
                cursor: pointer;
                transition: all 0.2s;
            }

            .modal-action-btn.primary {
                background: linear-gradient(145deg, #c0392b 0%, #a93226 100%);
                border: 2px solid #e74c3c;
                color: #f4e8d0;
            }

            .modal-action-btn.primary:hover {
                background: linear-gradient(145deg, #e74c3c 0%, #c0392b 100%);
            }

            /* Status Bar */
            .status-bar {
                background: linear-gradient(145deg, #2c1810 0%, #1a0f0a 100%);
                border-top: 2px solid #8b6914;
                padding: 12px 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 10px;
            }

            /* Bottom Navigation */
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(180deg, #2c1810 0%, #1a0f0a 100%);
                border-top: 3px solid #8b6914;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
                z-index: 100;
            }

            .nav-content {
                max-width: 800px;
                margin: 0 auto;
                display: flex;
                justify-content: space-around;
                padding: 10px 0;
            }

            .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 5px;
                padding: 8px 20px;
                color: #5c4018;
                text-decoration: none;
                transition: all 0.3s ease;
                position: relative;
            }

            .nav-item:hover {
                color: #d4a853;
            }

            .nav-item.active {
                color: #d4a853;
            }

            .nav-item.active::before {
                content: '';
                position: absolute;
                top: -13px;
                width: 40px;
                height: 3px;
                background: #d4a853;
                box-shadow: 0 0 10px rgba(212, 168, 83, 0.5);
            }

            .nav-icon {
                font-size: 24px;
            }

            .nav-label {
                font-size: 11px;
                font-weight: 600;
                font-family: 'Cinzel', serif;
            }

            /* Sidebar */
            .sidebar {
                width: 80px;
                background: linear-gradient(180deg, #3d2418 0%, #2c1810 100%);
                border-right: 3px solid #8b6914;
                padding: 16px 8px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .sidebar-btn {
                background: linear-gradient(145deg, #4d3428 0%, #3c2820 100%);
                border: 2px solid #6b5010;
                border-radius: 12px;
                padding: 10px 6px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                transition: all 0.2s;
                text-decoration: none;
            }

            .sidebar-btn:hover {
                border-color: #d4a853;
                transform: translateY(-2px);
            }

            .sidebar-btn.active {
                background: linear-gradient(145deg, #5d4438 0%, #4c3830 100%);
                border-color: #d4a853;
                box-shadow: 0 0 15px rgba(212, 168, 83, 0.3);
            }

            .sidebar-icon {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
            }

            .sidebar-btn.world .sidebar-icon { background: rgba(52, 152, 219, 0.3); }
            .sidebar-btn.party .sidebar-icon { background: rgba(155, 89, 182, 0.3); }
            .sidebar-btn.hero .sidebar-icon { background: rgba(212, 168, 83, 0.3); }

            .sidebar-label {
                font-size: 9px;
                color: #d4a853;
                font-family: 'Cinzel', serif;
                letter-spacing: 0.5px;
            }

            /* Compass */
            .compass {
                width: 56px;
                height: 56px;
                margin: 0 auto 8px;
                background: linear-gradient(145deg, #4d3428 0%, #3c2820 100%);
                border: 2px solid #8b6914;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .sidebar {
                    width: 60px;
                    padding: 12px 4px;
                }

                .sidebar-icon {
                    width: 28px;
                    height: 28px;
                    font-size: 16px;
                }

                .sidebar-label {
                    font-size: 8px;
                }

                .compass {
                    width: 44px;
                    height: 44px;
                    font-size: 22px;
                }

                .minimap-container {
                    width: 140px;
                    height: 110px;
                    padding: 8px;
                }

                .minimap-canvas {
                    height: 70px;
                }

                .zoom-controls {
                    bottom: 100px;
                }

                .zoom-btn {
                    width: 40px;
                    height: 40px;
                }
            }

            @media (max-width: 480px) {
                .header h1 {
                    font-size: 24px;
                }

                .resource-counter {
                    padding: 6px 10px;
                    font-size: 14px;
                }
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="max-w-[1400px] mx-auto flex items-center justify-between">
                <h1 class="font-fantasy text-3xl md:text-4xl font-bold text-amber-400" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5)">
                    MCOP Quest
                </h1>
                <div class="flex gap-3">
                    <div class="resource-counter">
                        <span class="text-amber-400 text-lg">ü™ô</span>
                        <span class="text-amber-200 text-xl font-bold">2,450</span>
                    </div>
                    <div class="resource-counter">
                        <span class="text-cyan-400 text-lg">üíé</span>
                        <span class="text-cyan-200 text-xl font-bold">15</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4">
            <div class="max-w-[1400px] mx-auto">
                <!-- Map Frame -->
                <div class="golden-frame rounded-lg overflow-hidden">
                    <div class="flex" style="height: calc(100vh - 220px); min-height: 500px;">
                        <!-- Map Area -->
                        <div id="map-container" class="flex-1 relative">
                            <canvas id="game-map"></canvas>

                            <!-- Loading Overlay -->
                            <div id="loading" class="loading-overlay">
                                <div class="loading-spinner mb-4"></div>
                                <p class="text-amber-400 text-xl font-fantasy">Loading Kingdom...</p>
                            </div>

                            <!-- Mini Map -->
                            <div class="minimap-container">
                                <p class="minimap-title">World Overview</p>
                                <canvas id="minimap" class="minimap-canvas" width="160" height="100"></canvas>
                            </div>

                            <!-- Zoom Controls -->
                            <div class="zoom-controls">
                                <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>
                                <button class="zoom-btn" id="zoom-out" title="Zoom Out">‚àí</button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Bar -->
                    <div class="status-bar">
                        <div class="flex items-center gap-6">
                            <span class="text-amber-200">Location: <span class="text-white font-bold" id="current-location">World Map</span></span>
                            <span class="text-amber-700">|</span>
                            <span class="text-amber-200">Active Tasks: <span class="text-green-400 font-bold">5</span></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-amber-400 text-sm" id="hover-status">Drag to pan ‚Ä¢ Scroll to zoom ‚Ä¢ Click locations</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Location Detail Modal -->
        <div id="location-modal" class="location-modal">
            <div class="modal-content">
                <h2 id="modal-title" class="modal-title">Location Name</h2>
                <div id="modal-content" class="modal-info">
                    <!-- Dynamic content -->
                </div>
                <div id="modal-actions" class="modal-actions">
                    <!-- Dynamic action buttons -->
                </div>
                <button id="close-modal" class="modal-close-btn">Close</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-content">
                <a href="hero-v2.html" class="nav-item">
                    <span class="nav-icon">‚öîÔ∏è</span>
                    <span class="nav-label">Hero</span>
                </a>
                <a href="team-v2.html" class="nav-item">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-label">Team</span>
                </a>
                <a href="world-map-v2.html" class="nav-item active">
                    <span class="nav-icon">üó∫Ô∏è</span>
                    <span class="nav-label">World</span>
                </a>
                <a href="shop-v2.html" class="nav-item">
                    <span class="nav-icon">üõí</span>
                    <span class="nav-label">Shop</span>
                </a>
            </div>
        </nav>

        <!-- Scripts -->
        <script type="module">
            import initMap from '../../../../public/js/map/index.js?v=2';

            // Map data with 8 locations
            const mapData = {
                width: 40,
                height: 30,
                tileSize: 128,
                layers: [
                    {
                        name: 'terrain',
                        data: generateTerrainLayer(40, 30)
                    },
                    {
                        name: 'roads',
                        data: generateRoadsLayer(40, 30)
                    }
                ],
                locations: [
                    {
                        id: 'member_city',
                        name: 'Member City',
                        nameTh: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',
                        x: 1536,
                        y: 1024,
                        type: 'castle',
                        health: 100,
                        maxHealth: 100,
                        status: 'full',
                        isFoggy: false,
                        boss: 'King of Members',
                        bossTitle: 'Master of User Management'
                    },
                    {
                        id: 'task_tower',
                        name: 'Task Tower',
                        nameTh: '‡∏´‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à',
                        x: 2560,
                        y: 640,
                        type: 'tower',
                        health: 75,
                        maxHealth: 100,
                        status: 'stable',
                        isFoggy: false,
                        boss: 'Task Master',
                        bossTitle: 'Keeper of Quests'
                    },
                    {
                        id: 'bug_bastion',
                        name: 'Bug Bastion',
                        nameTh: '‡∏õ‡πâ‡∏≠‡∏°‡∏ö‡∏±‡πä‡∏Å',
                        x: 3840,
                        y: 1280,
                        type: 'bastion',
                        health: 45,
                        maxHealth: 100,
                        status: 'medium',
                        isFoggy: false,
                        boss: 'Bug King',
                        bossTitle: 'Lord of Defects'
                    },
                    {
                        id: 'alchemy_lab',
                        name: 'Analytics Lab',
                        nameTh: '‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå',
                        x: 1792,
                        y: 2048,
                        type: 'lab',
                        health: 85,
                        maxHealth: 100,
                        status: 'stable',
                        isFoggy: false,
                        boss: 'Analytics Wizard',
                        bossTitle: 'Master of Data'
                    },
                    {
                        id: 'community_commons',
                        name: 'Community Commons',
                        nameTh: '‡∏•‡∏≤‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô',
                        x: 1024,
                        y: 2816,
                        type: 'market',
                        health: 90,
                        maxHealth: 100,
                        status: 'full',
                        isFoggy: false,
                        boss: 'Community Elder',
                        bossTitle: 'Guardian of Knowledge'
                    },
                    {
                        id: 'payment_fortress',
                        name: 'Payment Fortress',
                        nameTh: '‡∏õ‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô',
                        x: 3200,
                        y: 2560,
                        type: 'fortress',
                        health: 20,
                        maxHealth: 100,
                        status: 'low',
                        isFoggy: true,
                        boss: '???',
                        bossTitle: 'Unknown Entity'
                    },
                    {
                        id: 'product_city',
                        name: 'Product City',
                        nameTh: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                        x: 512,
                        y: 512,
                        type: 'merchant',
                        health: 80,
                        maxHealth: 100,
                        status: 'stable',
                        isFoggy: false,
                        boss: 'Product Queen',
                        bossTitle: 'Director of Features'
                    },
                    {
                        id: 'notification_tower',
                        name: 'Notification Tower',
                        nameTh: '‡∏´‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì',
                        x: 4224,
                        y: 512,
                        type: 'bell_tower',
                        health: 95,
                        maxHealth: 100,
                        status: 'full',
                        isFoggy: false,
                        boss: 'Bell Keeper',
                        bossTitle: 'Herald of Messages'
                    }
                ]
            };

            // Generate terrain layer with varied grass
            function generateTerrainLayer(width, height) {
                const data = [];
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        // Random grass variation
                        const grassType = Math.floor(Math.random() * 3) + 1;
                        data.push(grassType);
                    }
                }
                return data;
            }

            // Generate roads layer connecting locations
            function generateRoadsLayer(width, height) {
                const data = new Array(width * height).fill(0);

                function setRoad(x, y, type) {
                    if (x >= 0 && x < width && y >= 0 && y < height) {
                        data[y * width + x] = type;
                    }
                }

                // Road paths between locations
                const roads = [
                    { from: { x: 4, y: 4 }, to: { x: 12, y: 8 } },      // Product City to Member City
                    { from: { x: 12, y: 8 }, to: { x: 14, y: 16 } },    // Member City to Alchemy Lab
                    { from: { x: 14, y: 16 }, to: { x: 8, y: 22 } },    // Alchemy Lab to Community Commons
                    { from: { x: 12, y: 8 }, to: { x: 20, y: 5 } },     // Member City to Task Tower
                    { from: { x: 20, y: 5 }, to: { x: 30, y: 10 } },    // Task Tower to Bug Bastion
                    { from: { x: 30, y: 10 }, to: { x: 25, y: 20 } },   // Bug Bastion to Payment Fortress
                    { from: { x: 8, y: 22 }, to: { x: 25, y: 20 } },    // Community Commons to Payment Fortress
                    { from: { x: 20, y: 5 }, to: { x: 33, y: 4 } },     // Task Tower to Notification Tower
                ];

                for (const road of roads) {
                    const dx = road.to.x - road.from.x;
                    const dy = road.to.y - road.from.y;
                    const steps = Math.max(Math.abs(dx), Math.abs(dy));

                    for (let i = 0; i <= steps; i++) {
                        const t = i / steps;
                        const x = Math.round(road.from.x + dx * t);
                        const y = Math.round(road.from.y + dy * t);
                        setRoad(x, y, 5); // dirt road
                    }
                }

                return data;
            }

            // Initialize map
            let mapRenderer = null;

            async function init() {
                try {
                    mapRenderer = await initMap('game-map', mapData, {
                        exposeRenderer: (r) => { window.mapRenderer = r; },
                        onLocationClick: (location) => {
                            showLocationModal(location);
                        },
                        onLocationHover: (location) => {
                            const statusEl = document.getElementById('hover-status');
                            if (location) {
                                statusEl.textContent = `${location.name} - Health: ${location.health}%`;
                            } else {
                                statusEl.textContent = 'Drag to pan ‚Ä¢ Scroll to zoom ‚Ä¢ Click locations';
                            }
                        }
                    });

                    // Setup zoom buttons
                    document.getElementById('zoom-in').addEventListener('click', () => {
                        mapRenderer.zoomIn();
                    });
                    document.getElementById('zoom-out').addEventListener('click', () => {
                        mapRenderer.zoomOut();
                    });

                    // Hide loading
                    setTimeout(() => {
                        document.getElementById('loading').classList.add('hidden');
                    }, 1000);

                    // Setup minimap
                    setupMinimap();

                } catch (error) {
                    console.error('Failed to initialize map:', error);
                    document.getElementById('loading').innerHTML = `
                        <p class="text-red-400">Failed to load map</p>
                        <p class="text-amber-600 text-sm mt-2">${error.message}</p>
                    `;
                }
            }

            // Setup minimap
            function setupMinimap() {
                const minimap = document.getElementById('minimap');
                const ctx = minimap.getContext('2d');
                const width = minimap.width;
                const height = minimap.height;

                // Scale factors
                const scaleX = width / (mapData.width * mapData.tileSize);
                const scaleY = height / (mapData.height * mapData.tileSize);

                function drawMinimap() {
                    // Clear
                    ctx.fillStyle = '#2d5016';
                    ctx.fillRect(0, 0, width, height);

                    // Draw locations
                    for (const loc of mapData.locations) {
                        const x = loc.x * scaleX;
                        const y = loc.y * scaleY;
                        const size = 8;

                        // Get color based on health
                        let color = '#2ecc71';
                        if (loc.isFoggy) color = '#95a5a6';
                        else if (loc.health < 30) color = '#e74c3c';
                        else if (loc.health < 60) color = '#f1c40f';
                        else if (loc.health < 90) color = '#3498db';

                        ctx.fillStyle = color;
                        ctx.beginPath();
                        ctx.arc(x, y, size / 2, 0, Math.PI * 2);
                        ctx.fill();

                        // Border
                        ctx.strokeStyle = '#f1c40f';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }

                    // Draw viewport rectangle if renderer is ready
                    if (mapRenderer && mapRenderer.camera) {
                        const cam = mapRenderer.camera;
                        const vpX = (cam.x - cam.viewportWidth / 2 / cam.zoom) * scaleX;
                        const vpY = (cam.y - cam.viewportHeight / 2 / cam.zoom) * scaleY;
                        const vpW = (cam.viewportWidth / cam.zoom) * scaleX;
                        const vpH = (cam.viewportHeight / cam.zoom) * scaleY;

                        ctx.strokeStyle = '#f1c40f';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(vpX, vpY, vpW, vpH);
                    }
                }

                // Initial draw
                drawMinimap();

                // Update on animation frame
                function updateMinimap() {
                    drawMinimap();
                    requestAnimationFrame(updateMinimap);
                }
                updateMinimap();
            }

            // Modal functions
            function showLocationModal(location) {
                const modal = document.getElementById('location-modal');
                const title = document.getElementById('modal-title');
                const content = document.getElementById('modal-content');
                const actions = document.getElementById('modal-actions');

                title.textContent = location.name;

                const statusClass = location.isFoggy ? 'health-foggy' :
                    location.health >= 90 ? 'health-full' :
                    location.health >= 60 ? 'health-stable' :
                    location.health >= 30 ? 'health-medium' : 'health-low';

                const statusText = location.isFoggy ? 'FOG OF WAR' :
                    location.health >= 90 ? 'FULL' :
                    location.health >= 60 ? 'STABLE' :
                    location.health >= 30 ? 'MEDIUM' : 'LOW';

                content.innerHTML = `
                    <p><strong>Thai Name:</strong> ${location.nameTh}</p>
                    <p><strong>Health:</strong> ${location.health}/${location.maxHealth}</p>
                    <p><strong>Status:</strong> <span class="health-indicator ${statusClass}">${statusText}</span></p>
                    <p><strong>Type:</strong> ${location.type.replace('_', ' ').toUpperCase()}</p>
                    ${location.isFoggy ? '<p style="color: #e74c3c; margin-top: 10px;">‚ö†Ô∏è Fog of War - Requirements unclear</p>' : ''}
                `;

                // Add action buttons based on location type
                let actionButtons = '';
                if (!location.isFoggy) {
                    actionButtons += `<a href="city-v2.html?location=${location.id}" class="modal-action-btn primary">View City</a>`;
                }
                actions.innerHTML = actionButtons;

                // Add boss info if available
                if (location.boss) {
                    content.innerHTML += `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #5c4018;">
                            <p><strong>üëë City Boss:</strong> <span style="color: #e74c3c;">${location.boss}</span></p>
                            <p style="font-size: 14px; color: #8b6914; margin-top: 4px;">${location.bossTitle || 'Ruler of this domain'}</p>
                        </div>
                    `;
                }

                modal.classList.add('active');
            }

            // Close modal
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('location-modal').classList.remove('active');
            });

            document.getElementById('location-modal').addEventListener('click', (e) => {
                if (e.target.id === 'location-modal') {
                    document.getElementById('location-modal').classList.remove('active');
                }
            });

            // Start
            init();
        </script>
    </body>
</html>
