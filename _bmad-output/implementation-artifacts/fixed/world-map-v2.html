<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no"
        />
        <title>MCOP Quest - World Map</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1F5FA;</text></svg>">
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=VT323&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg-parchment: #e8dcc0;
                --bg-parchment-dark: #d4c8a8;
                --border-gold: #c9a227;
                --text-dark: #2c2416;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Crimson Text', Georgia, serif;
                background: linear-gradient(135deg, #1a0f0a 0%, #2c1810 50%, #1a0f0a 100%);
                color: #f4e8d0;
                min-height: 100vh;
                overflow-x: hidden;
                padding-bottom: 80px;
            }

            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image:
                    radial-gradient(circle at 20% 30%, rgba(212, 168, 83, 0.08) 0%, transparent 50%),
                    radial-gradient(circle at 80% 70%, rgba(192, 57, 43, 0.05) 0%, transparent 40%),
                    url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4a853' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                pointer-events: none;
                z-index: -1;
            }

            .font-fantasy {
                font-family: "Cinzel", serif;
            }

            .golden-frame {
                border: 8px solid var(--border-gold);
                border-image: linear-gradient(
                        135deg,
                        #bf953f 0%,
                        #fcf6ba 25%,
                        #b38728 50%,
                        #fbf5b7 75%,
                        #aa771c 100%
                    )
                    1;
                box-shadow:
                    inset 0 0 30px rgba(0, 0, 0, 0.5),
                    0 0 20px rgba(201, 162, 39, 0.3);
            }

            /* Header */
            .header {
                background: linear-gradient(180deg, #2c1810 0%, #1a0f0a 100%);
                border-bottom: 3px solid #8b6914;
                padding: 15px 20px;
                position: sticky;
                top: 0;
                z-index: 100;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            }

            .resource-counter {
                background: linear-gradient(145deg, #3d2418 0%, #2c1810 100%);
                border: 2px solid #8b6914;
                padding: 8px 16px;
                display: flex;
                align-items: center;
                gap: 8px;
                border-radius: 8px;
            }

            /* Map Container */
            #map-container {
                position: relative;
                background: linear-gradient(135deg, #1a3320 0%, #2d5016 50%, #1a3320 100%);
                overflow: hidden;
            }

            canvas {
                display: block;
                cursor: grab;
            }

            canvas:active {
                cursor: grabbing;
            }

            /* Loading Overlay */
            .loading-overlay {
                position: absolute;
                inset: 0;
                background: #1a1510;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 50;
                transition: opacity 0.5s;
            }

            .loading-overlay.hidden {
                opacity: 0;
                pointer-events: none;
            }

            .loading-spinner {
                width: 60px;
                height: 60px;
                border: 4px solid #d4a853;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Zoom Controls */
            .zoom-controls {
                position: absolute;
                bottom: 20px;
                right: 20px;
                display: flex;
                flex-direction: column;
                gap: 8px;
                z-index: 20;
            }

            .zoom-btn {
                width: 44px;
                height: 44px;
                background: linear-gradient(145deg, #3d2418 0%, #2c1810 100%);
                border: 2px solid #8b6914;
                border-radius: 8px;
                font-size: 24px;
                font-weight: bold;
                color: #d4a853;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: 'Cinzel', serif;
            }

            .zoom-btn:hover {
                background: linear-gradient(145deg, #4d3428 0%, #3c2820 100%);
                border-color: #d4a853;
                transform: scale(1.05);
            }

            /* Mini Map */
            .minimap-container {
                position: absolute;
                top: 16px;
                left: 16px;
                background: linear-gradient(145deg, #3d2418 0%, #2c1810 100%);
                border: 2px solid #8b6914;
                border-radius: 12px;
                padding: 10px;
                width: 180px;
                height: 140px;
                z-index: 20;
            }

            .minimap-title {
                font-family: 'Cinzel', serif;
                font-size: 11px;
                color: #d4a853;
                text-align: center;
                margin-bottom: 6px;
            }

            .minimap-canvas {
                width: 100%;
                height: 100px;
                background: #1a3320;
                border-radius: 6px;
                border: 1px solid #5c4018;
            }

            /* Location Modal */
            .location-modal {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.8);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 100;
                padding: 20px;
            }

            .location-modal.active {
                display: flex;
            }

            .modal-content {
                background: linear-gradient(145deg, #3d2418 0%, #2c1810 100%);
                border: 3px solid #8b6914;
                border-radius: 16px;
                padding: 24px;
                max-width: 400px;
                width: 100%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            }

            .modal-title {
                font-family: 'Cinzel', serif;
                font-size: 24px;
                color: #d4a853;
                margin-bottom: 16px;
                text-align: center;
            }

            .modal-info {
                color: #f4e8d0;
                font-size: 16px;
                line-height: 1.8;
            }

            .modal-info strong {
                color: #d4a853;
            }

            .health-indicator {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 4px;
                font-weight: bold;
                font-size: 14px;
            }

            .health-full { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
            .health-stable { background: rgba(52, 152, 219, 0.2); color: #3498db; }
            .health-medium { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
            .health-low { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
            .health-foggy { background: rgba(149, 165, 166, 0.2); color: #95a5a6; }

            .modal-close-btn {
                margin-top: 20px;
                width: 100%;
                background: linear-gradient(145deg, #8b6914 0%, #6b5010 100%);
                border: 2px solid #d4a853;
                color: #f4e8d0;
                padding: 12px;
                border-radius: 8px;
                font-family: 'Cinzel', serif;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .modal-close-btn:hover {
                background: linear-gradient(145deg, #9b7924 0%, #7b6020 100%);
            }

            /* Status Bar */
            .status-bar {
                background: linear-gradient(145deg, #2c1810 0%, #1a0f0a 100%);
                border-top: 2px solid #8b6914;
                padding: 12px 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 10px;
            }

            /* Bottom Navigation */
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(180deg, #2c1810 0%, #1a0f0a 100%);
                border-top: 3px solid #8b6914;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
                z-index: 100;
            }

            .nav-content {
                max-width: 800px;
                margin: 0 auto;
                display: flex;
                justify-content: space-around;
                padding: 10px 0;
            }

            .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 5px;
                padding: 8px 20px;
                color: #5c4018;
                text-decoration: none;
                transition: all 0.3s ease;
                position: relative;
            }

            .nav-item:hover {
                color: #d4a853;
            }

            .nav-item.active {
                color: #d4a853;
            }

            .nav-item.active::before {
                content: '';
                position: absolute;
                top: -13px;
                width: 40px;
                height: 3px;
                background: #d4a853;
                box-shadow: 0 0 10px rgba(212, 168, 83, 0.5);
            }

            .nav-icon {
                font-size: 24px;
            }

            .nav-label {
                font-size: 11px;
                font-weight: 600;
                font-family: 'Cinzel', serif;
            }

            /* Compass */
            .compass {
                width: 56px;
                height: 56px;
                margin: 0 auto 8px;
                background: linear-gradient(145deg, #4d3428 0%, #3c2820 100%);
                border: 2px solid #8b6914;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px;
            }

            /* Legend Panel */
            .legend-panel {
                position: absolute;
                top: 16px;
                right: 16px;
                background: linear-gradient(145deg, rgba(61, 36, 24, 0.95) 0%, rgba(44, 24, 16, 0.95) 100%);
                border: 2px solid #8b6914;
                border-radius: 12px;
                padding: 12px 16px;
                z-index: 20;
                min-width: 160px;
            }

            .legend-title {
                font-family: 'Cinzel', serif;
                font-size: 12px;
                color: #d4a853;
                margin-bottom: 8px;
                text-align: center;
                border-bottom: 1px solid #5c4018;
                padding-bottom: 6px;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 6px;
                font-size: 12px;
                color: #f4e8d0;
            }

            .legend-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                border: 2px solid #f1c40f;
            }

            .legend-dot.current { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
            .legend-dot.full { background: #2ecc71; }
            .legend-dot.stable { background: #3498db; }
            .legend-dot.medium { background: #f1c40f; }
            .legend-dot.low { background: #e74c3c; }
            .legend-dot.foggy { background: #95a5a6; }

            /* Responsive */
            @media (max-width: 768px) {
                .compass {
                    width: 44px;
                    height: 44px;
                    font-size: 22px;
                }

                .minimap-container {
                    width: 140px;
                    height: 110px;
                    padding: 8px;
                }

                .minimap-canvas {
                    height: 70px;
                }

                .zoom-controls {
                    bottom: 100px;
                }

                .zoom-btn {
                    width: 40px;
                    height: 40px;
                }

                .legend-panel {
                    display: none;
                }
            }

            @media (max-width: 480px) {
                .header h1 {
                    font-size: 24px;
                }

                .resource-counter {
                    padding: 6px 10px;
                    font-size: 14px;
                }
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="max-w-[1400px] mx-auto flex items-center justify-between">
                <h1 class="font-fantasy text-3xl md:text-4xl font-bold text-amber-400" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5)">
                    MCOP Quest
                </h1>
                <div class="flex gap-3">
                    <div class="resource-counter">
                        <span class="text-amber-400 text-lg">&#x1FA99;</span>
                        <span class="text-amber-200 text-xl font-bold">2,450</span>
                    </div>
                    <div class="resource-counter">
                        <span class="text-cyan-400 text-lg">&#x1F48E;</span>
                        <span class="text-cyan-200 text-xl font-bold">15</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4">
            <div class="max-w-[1400px] mx-auto">
                <!-- Map Frame -->
                <div class="golden-frame rounded-lg overflow-hidden">
                    <div class="flex" style="height: calc(100vh - 220px); min-height: 500px;">
                        <!-- Map Area -->
                        <div id="map-container" class="flex-1 relative">
                            <canvas id="game-map"></canvas>

                            <!-- Loading Overlay -->
                            <div id="loading" class="loading-overlay">
                                <div class="loading-spinner mb-4"></div>
                                <p class="text-amber-400 text-xl font-fantasy">Loading Kingdom...</p>
                            </div>

                            <!-- Mini Map -->
                            <div class="minimap-container">
                                <p class="minimap-title">World Overview</p>
                                <canvas id="minimap" class="minimap-canvas" width="160" height="100"></canvas>
                            </div>

                            <!-- Legend Panel -->
                            <div class="legend-panel">
                                <p class="legend-title">&#x1F4CD; Location Status</p>
                                <div class="legend-item">
                                    <div class="legend-dot current"></div>
                                    <span>You Are Here</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot full"></div>
                                    <span>Full Health (90%+)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot stable"></div>
                                    <span>Stable (60-89%)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot medium"></div>
                                    <span>Medium (30-59%)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot low"></div>
                                    <span>Low (&lt;30%)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot foggy"></div>
                                    <span>Fog of War</span>
                                </div>
                            </div>

                            <!-- Zoom Controls -->
                            <div class="zoom-controls">
                                <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>
                                <button class="zoom-btn" id="zoom-out" title="Zoom Out">&#x2212;</button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Bar -->
                    <div class="status-bar">
                        <div class="flex items-center gap-6">
                            <span class="text-amber-200">Location: <span class="text-white font-bold" id="current-location">World Map</span></span>
                            <span class="text-amber-700">|</span>
                            <span class="text-amber-200">Active Tasks: <span class="text-green-400 font-bold">5</span></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-amber-400 text-sm" id="hover-status">Drag to pan &#x2022; Scroll to zoom &#x2022; Click locations</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Location Detail Modal -->
        <div id="location-modal" class="location-modal">
            <div class="modal-content">
                <h2 id="modal-title" class="modal-title">Location Name</h2>
                <div id="modal-content" class="modal-info">
                    <!-- Dynamic content -->
                </div>
                <button id="close-modal" class="modal-close-btn">Close</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-content">
                <a href="hero-v2.html" class="nav-item">
                    <span class="nav-icon">&#x2694;</span>
                    <span class="nav-label">Hero</span>
                </a>
                <a href="team-v2.html" class="nav-item">
                    <span class="nav-icon">&#x1F465;</span>
                    <span class="nav-label">Team</span>
                </a>
                <a href="world-map-v2.html" class="nav-item active">
                    <span class="nav-icon">&#x1F5FA;</span>
                    <span class="nav-label">World</span>
                </a>
                <a href="shop-v2.html" class="nav-item">
                    <span class="nav-icon">&#x1F6D2;</span>
                    <span class="nav-label">Shop</span>
                </a>
            </div>
        </nav>

        <!-- Scripts -->
        <script>
            // ============================================
            // MAP RENDERER - Self-contained implementation
            // ============================================

            class MapRenderer {
                constructor(canvasId, mapData, options = {}) {
                    this.canvas = document.getElementById(canvasId);
                    if (!this.canvas) {
                        throw new Error(`Canvas with id '${canvasId}' not found`);
                    }

                    this.ctx = this.canvas.getContext('2d');
                    this.mapData = mapData;
                    this.options = options;

                    // Camera state
                    this.camera = {
                        x: mapData.width * mapData.tileSize / 2,
                        y: mapData.height * mapData.tileSize / 2,
                        zoom: 0.6,
                        minZoom: 0.3,
                        maxZoom: 2.0,
                        viewportWidth: 0,
                        viewportHeight: 0
                    };

                    // Interaction state
                    this.isDragging = false;
                    this.lastMouseX = 0;
                    this.lastMouseY = 0;
                    this.hoveredLocation = null;

                    // Animation
                    this.animationFrame = null;
                    this.time = 0;

                    this.init();
                }

                init() {
                    this.resize();
                    this.setupEventListeners();
                    this.startRenderLoop();

                    // Center on current location if specified
                    const currentLoc = this.mapData.locations.find(l => l.isCurrent);
                    if (currentLoc) {
                        this.camera.x = currentLoc.x;
                        this.camera.y = currentLoc.y;
                    }

                    // Expose renderer to window for debugging
                    if (this.options.exposeRenderer) {
                        this.options.exposeRenderer(this);
                    }
                }

                resize() {
                    const container = this.canvas.parentElement;
                    this.canvas.width = container.clientWidth;
                    this.canvas.height = container.clientHeight;
                    this.camera.viewportWidth = this.canvas.width;
                    this.camera.viewportHeight = this.canvas.height;
                }

                setupEventListeners() {
                    // Mouse events
                    this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                    this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                    this.canvas.addEventListener('mouseup', () => this.onMouseUp());
                    this.canvas.addEventListener('mouseleave', () => this.onMouseUp());
                    this.canvas.addEventListener('wheel', (e) => this.onWheel(e), { passive: false });

                    // Touch events
                    this.canvas.addEventListener('touchstart', (e) => this.onTouchStart(e), { passive: false });
                    this.canvas.addEventListener('touchmove', (e) => this.onTouchMove(e), { passive: false });
                    this.canvas.addEventListener('touchend', () => this.onMouseUp());

                    // Resize
                    window.addEventListener('resize', () => this.resize());
                }

                // Coordinate transformations
                worldToScreen(x, y) {
                    const scale = this.camera.zoom;
                    const screenX = (x - this.camera.x) * scale + this.camera.viewportWidth / 2;
                    const screenY = (y - this.camera.y) * scale + this.camera.viewportHeight / 2;
                    return { x: screenX, y: screenY };
                }

                screenToWorld(screenX, screenY) {
                    const scale = this.camera.zoom;
                    const x = (screenX - this.camera.viewportWidth / 2) / scale + this.camera.x;
                    const y = (screenY - this.camera.viewportHeight / 2) / scale + this.camera.y;
                    return { x, y };
                }

                // Event handlers
                onMouseDown(e) {
                    this.isDragging = true;
                    this.lastMouseX = e.clientX;
                    this.lastMouseY = e.clientY;
                    this.canvas.style.cursor = 'grabbing';
                }

                onMouseMove(e) {
                    const rect = this.canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;

                    if (this.isDragging) {
                        const dx = (e.clientX - this.lastMouseX) / this.camera.zoom;
                        const dy = (e.clientY - this.lastMouseY) / this.camera.zoom;
                        this.camera.x -= dx;
                        this.camera.y -= dy;
                        this.lastMouseX = e.clientX;
                        this.lastMouseY = e.clientY;
                    } else {
                        // Check for hover
                        this.checkHover(mouseX, mouseY);
                    }
                }

                onMouseUp() {
                    if (!this.isDragging) return;
                    this.isDragging = false;
                    this.canvas.style.cursor = 'grab';
                }

                onWheel(e) {
                    e.preventDefault();
                    const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                    const newZoom = Math.max(this.camera.minZoom, Math.min(this.camera.maxZoom, this.camera.zoom * zoomFactor));

                    if (newZoom !== this.camera.zoom) {
                        // Zoom towards mouse position
                        const rect = this.canvas.getBoundingClientRect();
                        const mouseX = e.clientX - rect.left;
                        const mouseY = e.clientY - rect.top;

                        const worldPos = this.screenToWorld(mouseX, mouseY);
                        this.camera.zoom = newZoom;
                        const newScreenPos = this.worldToScreen(worldPos.x, worldPos.y);

                        this.camera.x += (mouseX - newScreenPos.x) / this.camera.zoom;
                        this.camera.y += (mouseY - newScreenPos.y) / this.camera.zoom;
                    }
                }

                onTouchStart(e) {
                    if (e.touches.length === 1) {
                        this.isDragging = true;
                        this.lastMouseX = e.touches[0].clientX;
                        this.lastMouseY = e.touches[0].clientY;
                    }
                }

                onTouchMove(e) {
                    e.preventDefault();
                    if (e.touches.length === 1 && this.isDragging) {
                        const dx = (e.touches[0].clientX - this.lastMouseX) / this.camera.zoom;
                        const dy = (e.touches[0].clientY - this.lastMouseY) / this.camera.zoom;
                        this.camera.x -= dx;
                        this.camera.y -= dy;
                        this.lastMouseX = e.touches[0].clientX;
                        this.lastMouseY = e.touches[0].clientY;
                    }
                }

                checkHover(mouseX, mouseY) {
                    const worldPos = this.screenToWorld(mouseX, mouseY);
                    let found = null;

                    for (const loc of this.mapData.locations) {
                        const dx = worldPos.x - loc.x;
                        const dy = worldPos.y - loc.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 40) {
                            found = loc;
                            break;
                        }
                    }

                    if (found !== this.hoveredLocation) {
                        this.hoveredLocation = found;
                        if (this.options.onLocationHover) {
                            this.options.onLocationHover(found);
                        }
                        this.canvas.style.cursor = found ? 'pointer' : 'grab';
                    }
                }

                onClick(e) {
                    if (this.hoveredLocation && this.options.onLocationClick) {
                        this.options.onLocationClick(this.hoveredLocation);
                    }
                }

                // Zoom controls
                zoomIn() {
                    this.camera.zoom = Math.min(this.camera.maxZoom, this.camera.zoom * 1.3);
                }

                zoomOut() {
                    this.camera.zoom = Math.max(this.camera.minZoom, this.camera.zoom / 1.3);
                }

                // Rendering
                startRenderLoop() {
                    const loop = () => {
                        this.time += 0.016;
                        this.render();
                        this.animationFrame = requestAnimationFrame(loop);
                    };
                    loop();
                }

                render() {
                    const ctx = this.ctx;
                    const { width, height } = this.canvas;

                    // Clear
                    ctx.fillStyle = '#1a3320';
                    ctx.fillRect(0, 0, width, height);

                    // Calculate visible area
                    const topLeft = this.screenToWorld(0, 0);
                    const bottomRight = this.screenToWorld(width, height);

                    // Draw terrain
                    this.drawTerrain(topLeft, bottomRight);

                    // Draw roads
                    this.drawRoads();

                    // Draw locations
                    this.drawLocations();

                    // Draw grid overlay (subtle)
                    this.drawGrid();
                }

                drawTerrain(topLeft, bottomRight) {
                    const ctx = this.ctx;
                    const tileSize = this.mapData.tileSize;
                    const scale = this.camera.zoom;

                    // Grass colors
                    const grassColors = ['#2d5016', '#3d6b26', '#1a4010'];

                    const startX = Math.floor(topLeft.x / tileSize);
                    const endX = Math.ceil(bottomRight.x / tileSize);
                    const startY = Math.floor(topLeft.y / tileSize);
                    const endY = Math.ceil(bottomRight.y / tileSize);

                    for (let y = startY; y <= endY; y++) {
                        for (let x = startX; x <= endX; x++) {
                            if (x < 0 || x >= this.mapData.width || y < 0 || y >= this.mapData.height) {
                                continue;
                            }

                            const pos = this.worldToScreen(x * tileSize, y * tileSize);
                            const size = tileSize * scale;

                            // Use deterministic "random" based on position
                            const grassIndex = (x * 7 + y * 13) % 3;
                            ctx.fillStyle = grassColors[grassIndex];
                            ctx.fillRect(pos.x, pos.y, size + 1, size + 1);

                            // Add subtle texture variation
                            if ((x + y) % 5 === 0) {
                                ctx.fillStyle = 'rgba(0,0,0,0.05)';
                                ctx.fillRect(pos.x, pos.y, size, size);
                            }
                        }
                    }
                }

                drawRoads() {
                    const ctx = this.ctx;
                    const roads = this.mapData.roads || [];

                    ctx.strokeStyle = '#8b7355';
                    ctx.lineWidth = 8 * this.camera.zoom;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';

                    for (const road of roads) {
                        const from = this.worldToScreen(
                            road.from.x * this.mapData.tileSize,
                            road.from.y * this.mapData.tileSize
                        );
                        const to = this.worldToScreen(
                            road.to.x * this.mapData.tileSize,
                            road.to.y * this.mapData.tileSize
                        );

                        ctx.beginPath();
                        ctx.moveTo(from.x, from.y);
                        ctx.lineTo(to.x, to.y);
                        ctx.stroke();
                    }
                }

                drawLocations() {
                    const ctx = this.ctx;

                    for (const loc of this.mapData.locations) {
                        const pos = this.worldToScreen(loc.x, loc.y);
                        const scale = this.camera.zoom;
                        const baseSize = 30;
                        const size = baseSize * scale;

                        // Get color based on health
                        let color = '#2ecc71';
                        if (loc.isFoggy) color = '#95a5a6';
                        else if (loc.health < 30) color = '#e74c3c';
                        else if (loc.health < 60) color = '#f1c40f';
                        else if (loc.health < 90) color = '#3498db';

                        // Draw glow for current location
                        if (loc.isCurrent) {
                            const pulse = Math.sin(this.time * 3) * 0.3 + 0.7;
                            ctx.fillStyle = `rgba(46, 204, 113, ${0.4 * pulse})`;
                            ctx.beginPath();
                            ctx.arc(pos.x, pos.y, size * 1.5, 0, Math.PI * 2);
                            ctx.fill();

                            // Outer glow
                            ctx.fillStyle = `rgba(46, 204, 113, ${0.2 * pulse})`;
                            ctx.beginPath();
                            ctx.arc(pos.x, pos.y, size * 2.2, 0, Math.PI * 2);
                            ctx.fill();
                        }

                        // Draw location marker (circle with border)
                        ctx.fillStyle = color;
                        ctx.beginPath();
                        ctx.arc(pos.x, pos.y, size / 2, 0, Math.PI * 2);
                        ctx.fill();

                        // Border
                        ctx.strokeStyle = '#f1c40f';
                        ctx.lineWidth = 3 * scale;
                        ctx.stroke();

                        // Inner highlight
                        ctx.fillStyle = 'rgba(255,255,255,0.3)';
                        ctx.beginPath();
                        ctx.arc(pos.x - size * 0.15, pos.y - size * 0.15, size * 0.2, 0, Math.PI * 2);
                        ctx.fill();

                        // Draw location icon based on type
                        this.drawLocationIcon(loc.type, pos.x, pos.y, size * 0.5);

                        // Draw label
                        ctx.font = `bold ${14 * scale}px Cinzel, serif`;
                        ctx.textAlign = 'center';
                        ctx.fillStyle = '#f4e8d0';
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 3 * scale;
                        ctx.strokeText(loc.name, pos.x, pos.y + size * 0.9);
                        ctx.fillText(loc.name, pos.x, pos.y + size * 0.9);

                        // Draw health bar for non-foggy locations
                        if (!loc.isFoggy) {
                            const barWidth = 40 * scale;
                            const barHeight = 6 * scale;
                            const barX = pos.x - barWidth / 2;
                            const barY = pos.y + size * 1.1;

                            // Background
                            ctx.fillStyle = 'rgba(0,0,0,0.5)';
                            ctx.fillRect(barX, barY, barWidth, barHeight);

                            // Health
                            const healthPct = loc.health / loc.maxHealth;
                            ctx.fillStyle = color;
                            ctx.fillRect(barX, barY, barWidth * healthPct, barHeight);

                            // Border
                            ctx.strokeStyle = '#f1c40f';
                            ctx.lineWidth = 1 * scale;
                            ctx.strokeRect(barX, barY, barWidth, barHeight);
                        }

                        // Hover effect
                        if (this.hoveredLocation === loc) {
                            ctx.strokeStyle = '#fff';
                            ctx.lineWidth = 2 * scale;
                            ctx.beginPath();
                            ctx.arc(pos.x, pos.y, size * 0.6, 0, Math.PI * 2);
                            ctx.stroke();
                        }
                    }
                }

                drawLocationIcon(type, x, y, size) {
                    const ctx = this.ctx;
                    ctx.fillStyle = '#f4e8d0';
                    ctx.font = `${size}px serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const icons = {
                        castle: '\u{1F3F0}',
                        tower: '\u{1F3EF}',
                        bastion: '\u{1F6E1}',
                        lab: '\u{2697}',
                        market: '\u{1F3ED}',
                        fortress: '\u{1F3DB}',
                        merchant: '\u{1F4B0}',
                        bell_tower: '\u{1F514}'
                    };

                    const icon = icons[type] || '\u{1F3E0}';
                    ctx.fillText(icon, x, y);
                }

                drawGrid() {
                    const ctx = this.ctx;
                    const { width, height } = this.canvas;
                    const tileSize = this.mapData.tileSize * this.camera.zoom;

                    ctx.strokeStyle = 'rgba(255,255,255,0.03)';
                    ctx.lineWidth = 1;

                    const offsetX = (this.camera.viewportWidth / 2 - this.camera.x * this.camera.zoom) % tileSize;
                    const offsetY = (this.camera.viewportHeight / 2 - this.camera.y * this.camera.zoom) % tileSize;

                    ctx.beginPath();
                    for (let x = offsetX; x < width; x += tileSize) {
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, height);
                    }
                    for (let y = offsetY; y < height; y += tileSize) {
                        ctx.moveTo(0, y);
                        ctx.lineTo(width, y);
                    }
                    ctx.stroke();
                }
            }

            // ============================================
            // MAP DATA
            // ============================================

            const mapData = {
                width: 40,
                height: 30,
                tileSize: 128,
                locations: [
                    {
                        id: 'member_city',
                        name: 'Member City',
                        nameTh: '\u0E40\u0E21\u0E37\u0E2D\u0E07\u0E2A\u0E21\u0E32\u0E0A\u0E34\u0E01',
                        x: 1536,
                        y: 1024,
                        type: 'castle',
                        health: 100,
                        maxHealth: 100,
                        status: 'full',
                        isFoggy: false,
                        isCurrent: true
                    },
                    {
                        id: 'task_tower',
                        name: 'Task Tower',
                        nameTh: '\u0E2B\u0E2D\u0E04\u0E2D\u0E22\u0E20\u0E32\u0E23\u0E01\u0E34\u0E08',
                        x: 2560,
                        y: 640,
                        type: 'tower',
                        health: 75,
                        maxHealth: 100,
                        status: 'stable',
                        isFoggy: false,
                        isCurrent: false
                    },
                    {
                        id: 'bug_bastion',
                        name: 'Bug Bastion',
                        nameTh: '\u0E1B\u0E49\u0E2D\u0E21\u0E1A\u0E31\u0E4A\u0E01',
                        x: 3840,
                        y: 1280,
                        type: 'bastion',
                        health: 45,
                        maxHealth: 100,
                        status: 'medium',
                        isFoggy: false,
                        isCurrent: false
                    },
                    {
                        id: 'alchemy_lab',
                        name: 'Analytics Lab',
                        nameTh: '\u0E2B\u0E49\u0E2D\u0E07\u0E41\u0E25\u0E47\u0E1A\u0E27\u0E34\u0E40\u0E04\u0E23\u0E32\u0E30\u0E2B\u0E4C',
                        x: 1792,
                        y: 2048,
                        type: 'lab',
                        health: 85,
                        maxHealth: 100,
                        status: 'stable',
                        isFoggy: false,
                        isCurrent: false
                    },
                    {
                        id: 'community_commons',
                        name: 'Community Commons',
                        nameTh: '\u0E25\u0E32\u0E19\u0E0A\u0E38\u0E21\u0E0A\u0E19',
                        x: 1024,
                        y: 2816,
                        type: 'market',
                        health: 90,
                        maxHealth: 100,
                        status: 'full',
                        isFoggy: false,
                        isCurrent: false
                    },
                    {
                        id: 'payment_fortress',
                        name: 'Payment Fortress',
                        nameTh: '\u0E1B\u0E49\u0E2D\u0E21\u0E01\u0E32\u0E23\u0E40\u0E07\u0E34\u0E19',
                        x: 3200,
                        y: 2560,
                        type: 'fortress',
                        health: 20,
                        maxHealth: 100,
                        status: 'low',
                        isFoggy: true,
                        isCurrent: false
                    },
                    {
                        id: 'product_city',
                        name: 'Product City',
                        nameTh: '\u0E40\u0E21\u0E37\u0E2D\u0E07\u0E2A\u0E34\u0E19\u0E04\u0E49\u0E32',
                        x: 512,
                        y: 512,
                        type: 'merchant',
                        health: 80,
                        maxHealth: 100,
                        status: 'stable',
                        isFoggy: false,
                        isCurrent: false
                    },
                    {
                        id: 'notification_tower',
                        name: 'Notification Tower',
                        nameTh: '\u0E2B\u0E2D\u0E2A\u0E31\u0E0D\u0E0D\u0E32\u0E13',
                        x: 4224,
                        y: 512,
                        type: 'bell_tower',
                        health: 95,
                        maxHealth: 100,
                        status: 'full',
                        isFoggy: false,
                        isCurrent: false
                    }
                ],
                roads: [
                    { from: { x: 4, y: 4 }, to: { x: 12, y: 8 } },
                    { from: { x: 12, y: 8 }, to: { x: 14, y: 16 } },
                    { from: { x: 14, y: 16 }, to: { x: 8, y: 22 } },
                    { from: { x: 12, y: 8 }, to: { x: 20, y: 5 } },
                    { from: { x: 20, y: 5 }, to: { x: 30, y: 10 } },
                    { from: { x: 30, y: 10 }, to: { x: 25, y: 20 } },
                    { from: { x: 8, y: 22 }, to: { x: 25, y: 20 } },
                    { from: { x: 20, y: 5 }, to: { x: 33, y: 4 } }
                ]
            };

            // ============================================
            // INITIALIZATION
            // ============================================

            let mapRenderer = null;

            async function init() {
                try {
                    mapRenderer = new MapRenderer('game-map', mapData, {
                        exposeRenderer: (r) => { window.mapRenderer = r; },
                        onLocationClick: (location) => {
                            showLocationModal(location);
                        },
                        onLocationHover: (location) => {
                            const statusEl = document.getElementById('hover-status');
                            if (location) {
                                statusEl.textContent = `${location.name} - Health: ${location.health}%`;
                            } else {
                                statusEl.textContent = 'Drag to pan \u2022 Scroll to zoom \u2022 Click locations';
                            }
                        }
                    });

                    // Setup zoom buttons
                    document.getElementById('zoom-in').addEventListener('click', () => {
                        mapRenderer.zoomIn();
                    });
                    document.getElementById('zoom-out').addEventListener('click', () => {
                        mapRenderer.zoomOut();
                    });

                    // Setup click handler for locations
                    document.getElementById('game-map').addEventListener('click', (e) => {
                        mapRenderer.onClick(e);
                    });

                    // Hide loading
                    setTimeout(() => {
                        document.getElementById('loading').classList.add('hidden');
                    }, 800);

                    // Setup minimap
                    setupMinimap();

                } catch (error) {
                    console.error('Failed to initialize map:', error);
                    document.getElementById('loading').innerHTML = `
                        <p class="text-red-400">Failed to load map</p>
                        <p class="text-amber-600 text-sm mt-2">${error.message}</p>
                    `;
                }
            }

            // ============================================
            // MINIMAP
            // ============================================

            function setupMinimap() {
                const minimap = document.getElementById('minimap');
                const ctx = minimap.getContext('2d');
                const width = minimap.width;
                const height = minimap.height;

                const scaleX = width / (mapData.width * mapData.tileSize);
                const scaleY = height / (mapData.height * mapData.tileSize);

                function drawMinimap() {
                    ctx.fillStyle = '#1a3320';
                    ctx.fillRect(0, 0, width, height);

                    // Draw roads
                    ctx.strokeStyle = '#8b7355';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    for (const road of mapData.roads) {
                        const x1 = road.from.x * mapData.tileSize * scaleX;
                        const y1 = road.from.y * mapData.tileSize * scaleY;
                        const x2 = road.to.x * mapData.tileSize * scaleX;
                        const y2 = road.to.y * mapData.tileSize * scaleY;
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                    }
                    ctx.stroke();

                    // Draw locations
                    for (const loc of mapData.locations) {
                        const x = loc.x * scaleX;
                        const y = loc.y * scaleY;
                        const size = loc.isCurrent ? 12 : 8;

                        let color = '#2ecc71';
                        if (loc.isFoggy) color = '#95a5a6';
                        else if (loc.health < 30) color = '#e74c3c';
                        else if (loc.health < 60) color = '#f1c40f';
                        else if (loc.health < 90) color = '#3498db';

                        // Glow for current location
                        if (loc.isCurrent) {
                            ctx.fillStyle = 'rgba(46, 204, 113, 0.3)';
                            ctx.beginPath();
                            ctx.arc(x, y, size + 4, 0, Math.PI * 2);
                            ctx.fill();
                        }

                        ctx.fillStyle = color;
                        ctx.beginPath();
                        ctx.arc(x, y, size / 2, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.strokeStyle = '#f1c40f';
                        ctx.lineWidth = loc.isCurrent ? 2 : 1;
                        ctx.stroke();
                    }

                    // Draw viewport rectangle
                    if (mapRenderer && mapRenderer.camera) {
                        const cam = mapRenderer.camera;
                        const vpX = (cam.x - cam.viewportWidth / 2 / cam.zoom) * scaleX;
                        const vpY = (cam.y - cam.viewportHeight / 2 / cam.zoom) * scaleY;
                        const vpW = (cam.viewportWidth / cam.zoom) * scaleX;
                        const vpH = (cam.viewportHeight / cam.zoom) * scaleY;

                        ctx.strokeStyle = '#f1c40f';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(vpX, vpY, vpW, vpH);
                    }
                }

                drawMinimap();

                function updateMinimap() {
                    drawMinimap();
                    requestAnimationFrame(updateMinimap);
                }
                updateMinimap();
            }

            // ============================================
            // MODAL
            // ============================================

            function showLocationModal(location) {
                const modal = document.getElementById('location-modal');
                const title = document.getElementById('modal-title');
                const content = document.getElementById('modal-content');

                title.textContent = location.name;

                const statusClass = location.isFoggy ? 'health-foggy' :
                    location.health >= 90 ? 'health-full' :
                    location.health >= 60 ? 'health-stable' :
                    location.health >= 30 ? 'health-medium' : 'health-low';

                const statusText = location.isFoggy ? 'FOG OF WAR' :
                    location.health >= 90 ? 'FULL' :
                    location.health >= 60 ? 'STABLE' :
                    location.health >= 30 ? 'MEDIUM' : 'LOW';

                const currentBadge = location.isCurrent ?
                    '<span class="health-indicator health-full" style="margin-left: 8px;">\u{1F4CD} YOU ARE HERE</span>' : '';

                content.innerHTML = `
                    <p><strong>Thai Name:</strong> ${location.nameTh}</p>
                    <p><strong>Health:</strong> ${location.health}/${location.maxHealth} ${currentBadge}</p>
                    <p><strong>Status:</strong> <span class="health-indicator ${statusClass}">${statusText}</span></p>
                    <p><strong>Type:</strong> ${location.type.replace('_', ' ').toUpperCase()}</p>
                    ${location.isFoggy ? '<p style="color: #e74c3c; margin-top: 10px;">\u26A0 Fog of War - Requirements unclear</p>' : ''}
                `;

                modal.classList.add('active');
            }

            // Close modal
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('location-modal').classList.remove('active');
            });

            document.getElementById('location-modal').addEventListener('click', (e) => {
                if (e.target.id === 'location-modal') {
                    document.getElementById('location-modal').classList.remove('active');
                }
            });

            // Start
            document.addEventListener('DOMContentLoaded', init);
        </script>
    </body>
</html>
